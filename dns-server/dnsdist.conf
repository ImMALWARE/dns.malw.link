setACL({'0.0.0.0/0', '::/0'})

addLocal("0.0.0.0:53")
if io.open("/etc/dnsdist/certs/fullchain.cer") and io.open("/etc/dnsdist/certs/key.key") then
  addTLSLocal("0.0.0.0:853", "/etc/dnsdist/certs/fullchain.cer", "/etc/dnsdist/certs/key.key")
  addDOHLocal("0.0.0.0:443", "/etc/dnsdist/certs/fullchain.cer", "/etc/dnsdist/certs/key.key", "/dns-query")
else
  infolog("TLS certificates not found, skipping DoT and DoH listeners\n")
end

banned_ips = newNMG()
for line in io.lines("/etc/dnsdist/banned_ips.txt") do
  banned_ips:addMask(line)
end
addAction(NetmaskGroupRule(banned_ips), DropAction())
addAction(QTypeRule(DNSQType.ANY), DropAction())
addAction(QNameSuffixRule({"dhitc.com", "whoami.akamai.net"}), DropAction())

local log_all = os.getenv("LOG_ALL")
if log_all == "true" then
    addAction(AllRule(), LogAction("/dev/stdout", false, false, false))
end

newServer({address="1.1.1.1:853", tls="openssl", subjectName="cloudflare-dns.com", validateCertificates=true})
newServer({address="1.0.0.1:853", tls="openssl", subjectName="cloudflare-dns.com", validateCertificates=true})
newServer({address="8.8.8.8:853", tls="openssl", subjectName="dns.google", validateCertificates=true})
newServer({address="8.8.4.4:853", tls="openssl", subjectName="dns.google", validateCertificates=true})
newServer({address="9.9.9.9:853", tls="openssl", subjectName="dns.quad9.net", validateCertificates=true})
newServer({address="149.112.112.112:853", tls="openssl", subjectName="dns.quad9.net", validateCertificates=true})
newServer({address="208.67.222.222:53"})

local pc = newPacketCache(100000, {maxTTL=1800, minTTL=0, temporaryFailureTTL=60, staleTTL=3600, dontAge=false})
getPool(""):setCache(pc)

local sni_proxy_ips = {}
for line in io.lines("/etc/dnsdist/sni_proxy_ips.txt") do
  table.insert(sni_proxy_ips, line)
end

proxy_with_subdomains = newSuffixMatchNode()
for domain in io.lines("/etc/dnsdist/domains_with_subdomains.txt") do
  proxy_with_subdomains:add(newDNSName(domain))
end
custom_list = newSuffixMatchNode()
for domain in io.lines("/etc/dnsdist/custom.txt") do
  custom_list:add(newDNSName(domain))
end
addAction(QNameSuffixRule(proxy_with_subdomains), SpoofAction(sni_proxy_ips))
addAction(QNameSuffixRule(custom_list), SpoofAction(sni_proxy_ips))

for l1 in io.lines("/etc/dnsdist/hosts.txt") do
  ip, d = l1:match("(%S+)%s+(%S+)");
  addAction(d..".", SpoofAction(ip))
end

proxy = newDNSNameSet()
for l2 in io.lines("/etc/dnsdist/domains.txt") do proxy:add(newDNSName(l2)) end
addAction(QNameSetRule(proxy), SpoofAction(sni_proxy_ips))

addAction(QNameSuffixRule({'googlesyndication.com.', 'adcolony.com.', 'hotjar.com.', 'mouseflow.com.', 'freshmarketer.com.', 'luckyorange.com.', 'bugsnag.com.', 'samsungads.com.', 'doubleclick.net.', 'media.net.', 'sentry.com.', 'sentry.io.'}), DropAction())

garbage = newDNSNameSet()
for l3 in io.lines("/etc/dnsdist/garbage.txt") do garbage:add(newDNSName(l3)) end
addAction(QNameSetRule(garbage), DropAction())